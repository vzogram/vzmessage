<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VZMessage</title>
    <style>
        :root {
            --primary-color: #8a2be2;
            --secondary-color: #9932cc;
            --accent-color: #ba55d3;
            --background-color: #1a1a2e;
            --chat-bg: #16213e;
            --message-sent: #8a2be2;
            --message-received: #2d2d44;
            --text-color: #ffffff;
            --border-color: #4a4a6a;
            --hover-color: #7b1fa2;
            --error-color: #ff3860;
            --success-color: #23d160;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes neon-glow {
            0%, 100% { box-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color), 0 0 15px var(--primary-color); }
            50% { box-shadow: 0 0 10px var(--accent-color), 0 0 20px var(--accent-color), 0 0 30px var(--accent-color); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--background-color) 0%, #0f3460 100%);
        }

        .auth-box {
            background-color: var(--chat-bg);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
            animation: fadeIn 0.5s ease-out;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 25px;
            font-size: 28px;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-color);
            outline: none;
            transition: all 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--primary-color);
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .auth-button:hover {
            background-color: var(--secondary-color);
            animation: neon-glow 1.5s infinite;
        }

        .error-message {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ */
        .container {
            display: flex;
            height: 100%;
        }

        .sidebar {
            width: 30%;
            background-color: var(--chat-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .profile-header {
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .profile-info {
            flex: 1;
        }

        .profile-nickname {
            font-weight: bold;
            font-size: 16px;
        }

        .profile-username {
            font-size: 12px;
            opacity: 0.7;
        }

        .menu-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .menu-button:hover {
            background-color: var(--hover-color);
            box-shadow: 0 0 8px var(--accent-color);
        }

        .search-container {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-color);
            outline: none;
            transition: box-shadow 0.3s;
        }

        .search-input:focus {
            box-shadow: 0 0 8px var(--accent-color);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-item:hover {
            background-color: var(--hover-color);
        }

        .chat-item.active {
            background-color: var(--secondary-color);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chat-last-message {
            font-size: 14px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .new-chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 100;
        }

        .new-chat-button:hover {
            transform: scale(1.1);
            animation: neon-glow 1.5s infinite;
        }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            background-color: var(--chat-bg);
        }

        .chat-title {
            font-weight: bold;
            font-size: 18px;
        }

        .chat-actions {
            margin-left: auto;
        }

        .action-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .action-button:hover {
            background-color: var(--hover-color);
            box-shadow: 0 0 8px var(--accent-color);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--background-color);
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
            animation: fadeIn 0.3s ease-out;
        }

        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            display: inline-block;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background-color: var(--message-sent);
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            background-color: var(--message-received);
            border-bottom-left-radius: 5px;
        }

        .message-sender {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        .message-time {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.6;
        }

        .input-area {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            background-color: var(--chat-bg);
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-color);
            outline: none;
            resize: none;
            transition: box-shadow 0.3s;
        }

        .message-input:focus {
            box-shadow: 0 0 8px var(--accent-color);
        }

        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover {
            background-color: var(--secondary-color);
            animation: neon-glow 1.5s infinite;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--chat-bg);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.5);
        }

        .modal-title {
            margin-bottom: 20px;
            font-size: 22px;
            color: var(--primary-color);
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .modal-button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-button.primary:hover {
            background-color: var(--secondary-color);
            animation: neon-glow 1.5s infinite;
        }

        .modal-button.secondary {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .file-label:hover {
            background-color: var(--hover-color);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .sidebar.active {
                display: flex;
            }
            
            .chat-area {
                display: none;
            }
            
            .chat-area.active {
                display: flex;
            }
            
            .menu-button.mobile-toggle {
                display: block;
            }
            
            .message {
                max-width: 85%;
            }
        }

        @media (min-width: 769px) {
            .menu-button.mobile-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authPage" class="auth-container">
        <div class="auth-box">
            <h1 class="auth-title">VZMessage</h1>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">–í—Ö–æ–¥</div>
                <div class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="form-input" placeholder="Email" required>
                    <div class="error-message" id="loginEmailError"></div>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" class="form-input" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                <button type="submit" class="auth-button">–í–æ–π—Ç–∏</button>
            </form>
            
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <input type="email" id="registerEmail" class="form-input" placeholder="Email" required>
                    <div class="error-message" id="registerEmailError"></div>
                </div>
                <div class="form-group">
                    <input type="text" id="registerNickname" class="form-input" placeholder="–ù–∏–∫–Ω–µ–π–º" required>
                    <div class="error-message" id="registerNicknameError"></div>
                </div>
                <div class="form-group">
                    <input type="text" id="registerUsername" class="form-input" placeholder="Username (—Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)" required>
                    <div class="error-message" id="registerUsernameError"></div>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" class="form-input" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    <div class="error-message" id="registerPasswordError"></div>
                </div>
                <div class="form-group">
                    <input type="password" id="registerConfirmPassword" class="form-input" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                    <div class="error-message" id="registerConfirmPasswordError"></div>
                </div>
                <button type="submit" class="auth-button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
    <div id="app" class="container" style="display: none;">
        <!-- –°–∞–π–¥–±–∞—Ä —Å —á–∞—Ç–∞–º–∏ -->
        <div class="sidebar" id="sidebar">
            <div class="profile-header">
                <img src="" alt="–ê–≤–∞—Ç–∞—Ä" class="profile-avatar" id="profileAvatar">
                <div class="profile-info">
                    <div class="profile-nickname" id="profileNickname"></div>
                    <div class="profile-username" id="profileUsername"></div>
                </div>
                <button class="menu-button" id="profileMenu">‚ò∞</button>
                <button class="menu-button mobile-toggle" id="toggleSidebar">‚Üê</button>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ username...">
            </div>
            
            <div class="chats-list" id="chatsList">
                <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header">
                <button class="menu-button mobile-toggle" id="toggleChatArea">‚ò∞</button>
                <div class="chat-title" id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                <div class="chat-actions">
                    <button class="action-button" id="chatInfoButton" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ">‚ÑπÔ∏è</button>
                    <button class="action-button" id="deleteChatButton" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">üóëÔ∏è</button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                <div class="welcome-message">
                    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VZMessage!</p>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è.</p>
                </div>
            </div>
            
            <div class="input-area">
                <input type="file" id="fileInput" class="file-input">
                <label for="fileInput" class="file-label">üìé</label>
                <textarea class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button class="send-button" id="sendButton">‚û§</button>
            </div>
        </div>
        
        <button class="new-chat-button" id="newChatButton">+</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <div class="form-group">
                <label>–ê–≤–∞—Ç–∞—Ä–∫–∞:</label>
                <input type="file" id="avatarUpload" accept="image/*">
                <div id="avatarPreview"></div>
            </div>
            <div class="form-group">
                <label>–ù–∏–∫–Ω–µ–π–º:</label>
                <input type="text" id="profileNicknameInput" class="form-input">
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="profileUsernameInput" class="form-input">
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" id="closeProfileModal">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-button primary" id="saveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="modal-button secondary" id="logoutButton">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <h2 class="modal-title">–ù–æ–≤—ã–π —á–∞—Ç</h2>
            <div class="form-group">
                <label>–¢–∏–ø —á–∞—Ç–∞:</label>
                <select id="chatType" class="form-input">
                    <option value="private">–õ–∏—á–Ω—ã–π —á–∞—Ç</option>
                    <option value="group">–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</option>
                </select>
            </div>
            <div class="form-group" id="usernameSearchGroup">
                <label>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="searchUsername" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ username">
                <div id="searchResults"></div>
            </div>
            <div class="form-group" id="groupSettings" style="display: none;">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                <input type="text" id="groupName" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                <label>–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã:</label>
                <input type="file" id="groupAvatarUpload" accept="image/*">
                <div id="groupAvatarPreview"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" id="closeNewChatModal">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-button primary" id="createChatButton">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ -->
    <div class="modal" id="chatInfoModal">
        <div class="modal-content">
            <h2 class="modal-title" id="chatInfoTitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</h2>
            <div id="chatInfoContent">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="modal-buttons">
                <button class="modal-button primary" id="closeChatInfoModal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let users = {};
        let chats = {};
        let currentChatId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
            loadData();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            if (currentUser) {
                showApp();
            } else {
                showAuth();
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadData() {
            const savedUsers = localStorage.getItem('vzmessage_users');
            const savedChats = localStorage.getItem('vzmessage_chats');
            const savedCurrentUser = localStorage.getItem('vzmessage_currentUser');
            
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            if (savedChats) {
                chats = JSON.parse(savedChats);
            }
            
            if (savedCurrentUser) {
                currentUser = JSON.parse(savedCurrentUser);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveData() {
            localStorage.setItem('vzmessage_users', JSON.stringify(users));
            localStorage.setItem('vzmessage_chats', JSON.stringify(chats));
            if (currentUser) {
                localStorage.setItem('vzmessage_currentUser', JSON.stringify(currentUser));
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuth() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateProfileInfo();
            updateChatsList();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Form').classList.add('active');
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                loginUser();
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                registerUser();
            });
            
            // –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('profileMenu').addEventListener('click', function() {
                document.getElementById('profileModal').classList.add('active');
                loadProfileData();
            });
            
            // –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
            document.getElementById('newChatButton').addEventListener('click', function() {
                document.getElementById('newChatModal').classList.add('active');
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —á–∞—Ç–∞
            document.getElementById('chatType').addEventListener('change', function() {
                const isGroup = this.value === 'group';
                document.getElementById('usernameSearchGroup').style.display = isGroup ? 'none' : 'block';
                document.getElementById('groupSettings').style.display = isGroup ? 'block' : 'none';
            });
            
            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            document.getElementById('searchUsername').addEventListener('input', function() {
                searchUsers(this.value);
            });
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
            document.getElementById('createChatButton').addEventListener('click', createChat);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.getElementById('closeProfileModal').addEventListener('click', function() {
                document.getElementById('profileModal').classList.remove('active');
            });
            
            document.getElementById('closeNewChatModal').addEventListener('click', function() {
                document.getElementById('newChatModal').classList.remove('active');
            });
            
            document.getElementById('closeChatInfoModal').addEventListener('click', function() {
                document.getElementById('chatInfoModal').classList.remove('active');
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('saveProfile').addEventListener('click', saveProfile);
            
            // –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ
            document.getElementById('chatInfoButton').addEventListener('click', showChatInfo);
            
            // –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
            document.getElementById('deleteChatButton').addEventListener('click', deleteChat);
            
            // –ú–æ–±–∏–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('chatArea').classList.add('active');
            });
            
            document.getElementById('toggleChatArea').addEventListener('click', function() {
                document.getElementById('chatArea').classList.remove('active');
                document.getElementById('sidebar').classList.add('active');
            });
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function registerUser() {
            const email = document.getElementById('registerEmail').value;
            const nickname = document.getElementById('registerNickname').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            let isValid = true;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
            if (!isValidEmail(email)) {
                showError('registerEmailError', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                isValid = false;
            } else {
                hideError('registerEmailError');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∏–∫–Ω–µ–π–º–∞
            if (nickname.length < 2) {
                showError('registerNicknameError', '–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                isValid = false;
            } else {
                hideError('registerNicknameError');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ username
            if (!isValidUsername(username)) {
                showError('registerUsernameError', 'Username –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã');
                isValid = false;
            } else if (users[username]) {
                showError('registerUsernameError', '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç');
                isValid = false;
            } else {
                hideError('registerUsernameError');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
            if (password.length < 6) {
                showError('registerPasswordError', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                isValid = false;
            } else {
                hideError('registerPasswordError');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
            if (password !== confirmPassword) {
                showError('registerConfirmPasswordError', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                isValid = false;
            } else {
                hideError('registerConfirmPasswordError');
            }
            
            if (!isValid) return;
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            users[username] = {
                email: email,
                nickname: nickname,
                username: username,
                password: password, // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è!
                avatar: null,
                chats: []
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            saveData();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
            currentUser = users[username];
            saveData();
            showApp();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('registerForm').reset();
        }

        // –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
            let user = null;
            for (const username in users) {
                if (users[username].email === email) {
                    user = users[username];
                    break;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (!user) {
                showError('loginEmailError', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            } else {
                hideError('loginEmailError');
            }
            
            if (user.password !== password) {
                showError('loginPasswordError', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                return;
            } else {
                hideError('loginPasswordError');
            }
            
            // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
            currentUser = user;
            saveData();
            showApp();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('loginForm').reset();
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        function logout() {
            currentUser = null;
            saveData();
            showAuth();
            document.getElementById('profileModal').classList.remove('active');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        function updateProfileInfo() {
            if (!currentUser) return;
            
            document.getElementById('profileNickname').textContent = currentUser.nickname;
            document.getElementById('profileUsername').textContent = '@' + currentUser.username;
            
            if (currentUser.avatar) {
                document.getElementById('profileAvatar').src = currentUser.avatar;
            } else {
                document.getElementById('profileAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM4YTJiZTIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJ3aGl0ZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDBDMTEuMzMgMCAxMi40MyAwLjY3IDEzLjE3IDEuNjVDMTMuOTMgMi42MyAxNC4zMyAzLjg3IDE0LjMzIDUuMzNDMTQuMzMgNi44IDEzLjkzIDggMTMuMTcgOUMyNC0yIDEyLjQzIDEwIDEwIDEwQzcuNTcgMTAgNiA4LjQzIDYgNkM2IDMuNTcgNy41NyAyIDEwIDJaTTEwIDEyQzEzLjMzIDEyIDE2IDE0LjY3IDE2IDE4SDRDNCwxNC42NyA2LjY3IDEyIDEwIDEyWiIvPgo8L3N2Zz4KPC9zdmc+';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function loadProfileData() {
            if (!currentUser) return;
            
            document.getElementById('profileNicknameInput').value = currentUser.nickname;
            document.getElementById('profileUsernameInput').value = currentUser.username;
            
            const avatarPreview = document.getElementById('avatarPreview');
            if (currentUser.avatar) {
                avatarPreview.innerHTML = `<img src="${currentUser.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 100px; height: 100px; border-radius: 50%;">`;
            } else {
                avatarPreview.innerHTML = '';
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        function saveProfile() {
            if (!currentUser) return;
            
            const newNickname = document.getElementById('profileNicknameInput').value;
            const newUsername = document.getElementById('profileUsernameInput').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (newNickname.length < 2) {
                alert('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            
            if (!isValidUsername(newUsername)) {
                alert('Username –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å username
            if (newUsername !== currentUser.username && users[newUsername]) {
                alert('–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
            const avatarFile = document.getElementById('avatarUpload').files[0];
            if (avatarFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.avatar = e.target.result;
                    updateUserData();
                };
                reader.readAsDataURL(avatarFile);
            } else {
                updateUserData();
            }
            
            function updateUserData() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (newUsername !== currentUser.username) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π username –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                    delete users[currentUser.username];
                    users[newUsername] = currentUser;
                }
                
                currentUser.nickname = newNickname;
                currentUser.username = newUsername;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤ —á–∞—Ç–∞—Ö
                for (const chatId in chats) {
                    const chat = chats[chatId];
                    if (chat.participants.includes(currentUser.username)) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∫–Ω–µ–π–º –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                        chat.messages.forEach(message => {
                            if (message.sender === currentUser.username) {
                                message.senderNickname = newNickname;
                            }
                        });
                    }
                }
                
                saveData();
                updateProfileInfo();
                updateChatsList();
                document.getElementById('profileModal').classList.remove('active');
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers(query) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            if (query.length < 1) return;
            
            const results = [];
            for (const username in users) {
                if (username.includes(query) && username !== currentUser.username) {
                    results.push(users[username]);
                }
            }
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            results.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'chat-item';
                userElement.innerHTML = `
                    <img src="${user.avatar || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM4YTJiZTIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJ3aGl0ZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDBDMTEuMzMgMCAxMi40MyAwLjY3IDEzLjE3IDEuNjVDMTMuOTMgMi42MyAxNC4zMyAzLjg3IDE0LjMzIDUuMzNDMTQuMzMgNi44IDEzLjkzIDggMTMuMTcgOUMyNC0yIDEyLjQzIDEwIDEwIDEwQzcuNTcgMTAgNiA4LjQzIDYgNkM2IDMuNTcgNy41NyAyIDEwIDJaTTEwIDEyQzEzLjMzIDEyIDE2IDE0LjY3IDE2IDE4SDRDNCwxNC42NyA2LjY3IDEyIDEwIDEyWiIvPgo8L3N2Zz4KPC9zdmc+'}" alt="–ê–≤–∞—Ç–∞—Ä" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${user.nickname}</div>
                        <div class="chat-last-message">@${user.username}</div>
                    </div>
                `;
                userElement.addEventListener('click', function() {
                    createPrivateChat(user.username);
                });
                resultsContainer.appendChild(userElement);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
        function createPrivateChat(username) {
            const chatId = [currentUser.username, username].sort().join('_');
            
            if (!chats[chatId]) {
                chats[chatId] = {
                    id: chatId,
                    type: 'private',
                    participants: [currentUser.username, username],
                    messages: [],
                    title: users[username].nickname,
                    avatar: users[username].avatar
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                users[currentUser.username].chats.push(chatId);
                users[username].chats.push(chatId);
                
                saveData();
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            openChat(chatId);
            document.getElementById('newChatModal').classList.remove('active');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function createGroupChat() {
            const groupName = document.getElementById('groupName').value;
            
            if (!groupName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            const chatId = 'group_' + Date.now();
            const participants = [currentUser.username];
            
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
            // –í –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            
            chats[chatId] = {
                id: chatId,
                type: 'group',
                participants: participants,
                messages: [],
                title: groupName,
                avatar: null,
                admin: currentUser.username
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
            const avatarFile = document.getElementById('groupAvatarUpload').files[0];
            if (avatarFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    chats[chatId].avatar = e.target.result;
                    saveData();
                };
                reader.readAsDataURL(avatarFile);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            participants.forEach(username => {
                if (users[username]) {
                    users[username].chats.push(chatId);
                }
            });
            
            saveData();
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            openChat(chatId);
            document.getElementById('newChatModal').classList.remove('active');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ (–æ–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function createChat() {
            const chatType = document.getElementById('chatType').value;
            
            if (chatType === 'private') {
                // –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ –Ω—É–∂–µ–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                // –í –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º —á–∞—Ç —Å –ø–µ—Ä–≤—ã–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                for (const username in users) {
                    if (username !== currentUser.username) {
                        createPrivateChat(username);
                        return;
                    }
                }
                alert('–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞');
            } else {
                createGroupChat();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        function updateChatsList() {
            if (!currentUser) return;
            
            const chatsList = document.getElementById('chatsList');
            chatsList.innerHTML = '';
            
            currentUser.chats.forEach(chatId => {
                const chat = chats[chatId];
                if (!chat) return;
                
                const lastMessage = chat.messages.length > 0 ? 
                    chat.messages[chat.messages.length - 1] : 
                    { text: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π', time: Date.now() };
                
                const chatElement = document.createElement('div');
                chatElement.className = 'chat-item' + (currentChatId === chatId ? ' active' : '');
                chatElement.dataset.chatId = chatId;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                let chatTitle = chat.title;
                if (chat.type === 'private') {
                    const otherUser = chat.participants.find(p => p !== currentUser.username);
                    if (users[otherUser]) {
                        chatTitle = users[otherUser].nickname;
                    }
                }
                
                chatElement.innerHTML = `
                    <img src="${chat.avatar || (chat.type === 'private' ? 
                        (users[chat.participants.find(p => p !== currentUser.username)]?.avatar || 
                         'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM4YTJiZTIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJ3aGl0ZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDBDMTEuMzMgMCAxMi40MyAwLjY3IDEzLjE3IDEuNjVDMTMuOTMgMi42MyAxNC4zMyAzLjg3IDE0LjMzIDUuMzNDMTQuMzMgNi44IDEzLjkzIDggMTMuMTcgOUMyNC0yIDEyLjQzIDEwIDEwIDEwQzcuNTcgMTAgNiA4LjQzIDYgNkM2IDMuNTcgNy41NyAyIDEwIDJaTTEwIDEyQzEzLjMzIDEyIDE2IDE0LjY3IDE6IDE4SDRDNCwxNC42NyA2LjY3IDEyIDEwIDEyWiIvPgo8L3N2Zz4KPC9zdmc+') : 
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM4YTJiZTIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJ3aGl0ZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEwIDBDMTEuMzMgMCAxMi40MyAwLjY3IDEzLjE3IDEuNjVDMTMuOTMgMi42MyAxNC4zMyAzLjg3IDE0LjMzIDUuMzNDMTQuMzMgNi44IDEzLjkzIDggMTMuMTcgOUMyNC0yIDEyLjQzIDEwIDEwIDEwQzcuNTcgMTAgNiA4LjQzIDYgNkM2IDMuNTcgNy41NyAyIDEwIDJaTTEwIDEyQzEzLjMzIDEyIDE2IDE0LjY3IDE2IDE4SDRDNCwxNC42NyA2LjY3IDEyIDEwIDEyWiIvPgo8L3N2Zz4KPC9zdmc+')}" 
                        alt="–ê–≤–∞—Ç–∞—Ä" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${chatTitle}</div>
                        <div class="chat-last-message">${lastMessage.text || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                `;
                
                chatElement.addEventListener('click', function() {
                    openChat(chatId);
                });
                
                chatsList.appendChild(chatElement);
            });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
        function openChat(chatId) {
            currentChatId = chatId;
            const chat = chats[chatId];
            
            if (!chat) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            let chatTitle = chat.title;
            if (chat.type === 'private') {
                const otherUser = chat.participants.find(p => p !== currentUser.username);
                if (users[otherUser]) {
                    chatTitle = users[otherUser].nickname;
                }
            }
            document.getElementById('chatTitle').textContent = chatTitle;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            updateMessages();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.chatId === chatId) {
                    item.classList.add('active');
                }
            });
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('chatArea').classList.add('active');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
        function updateMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            if (!currentChatId || !chats[currentChatId]) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VZMessage!</p>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è.</p>
                    </div>
                `;
                return;
            }
            
            const chat = chats[currentChatId];
            
            if (chat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <p>–ß–∞—Ç "${chat.title}"</p>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
                    </div>
                `;
                return;
            }
            
            chat.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sender === currentUser.username ? 'sent' : 'received'}`;
                
                let messageContent = '';
                if (message.type === 'file') {
                    messageContent = `
                        <div class="message-sender">${message.senderNickname || users[message.sender]?.nickname || message.sender}</div>
                        <div class="message-content">
                            <a href="${message.fileUrl}" download="${message.fileName}">üìé ${message.fileName}</a>
                        </div>
                    `;
                } else {
                    messageContent = `
                        <div class="message-sender">${message.senderNickname || users[message.sender]?.nickname || message.sender}</div>
                        <div class="message-content">${message.text}</div>
                    `;
                }
                
                messageElement.innerHTML = messageContent + `
                    <div class="message-time">${formatTime(message.time)}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            if (!currentChatId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text) return;
            
            const message = {
                id: Date.now(),
                text: text,
                sender: currentUser.username,
                senderNickname: currentUser.nickname,
                time: Date.now(),
                type: 'text'
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            chats[currentChatId].messages.push(message);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            saveData();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateMessages();
            updateChatsList();
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file || !currentChatId) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const message = {
                    id: Date.now(),
                    fileName: file.name,
                    fileUrl: e.target.result,
                    sender: currentUser.username,
                    senderNickname: currentUser.nickname,
                    time: Date.now(),
                    type: 'file'
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                chats[currentChatId].messages.push(message);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                saveData();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateMessages();
                updateChatsList();
            };
            reader.readAsDataURL(file);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input
            e.target.value = '';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
        function showChatInfo() {
            if (!currentChatId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                return;
            }
            
            const chat = chats[currentChatId];
            const chatInfoContent = document.getElementById('chatInfoContent');
            
            let content = '';
            
            if (chat.type === 'private') {
                const otherUser = chat.participants.find(p => p !== currentUser.username);
                const user = users[otherUser];
                
                content = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${user.avatar || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiM4YTJiZTIiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJ3aGl0ZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDBDMjIuNjYgMCAyNC44NiAxLjM0IDI2LjM0IDMuM0MyNy44NiA1LjI2IDI4LjY2IDcuNzQgMjguNjYgMTAuNjZDMjguNjYgMTMuNiAyNy44NiAxNiAyNi4zNCAxOEM0OC00IDI0Ljg2IDIwIDIwIDIwQzE1LjE0IDIwIDEyIDE2Ljg2IDEyIDEyQzEyIDcuMTQgMTUuMTQgNCAyMCA0Wk0yMCAyNEMyNi42NiAyNCAzMiAyOS4zNCAzMiIDM2SDhDOCwyOS4zNCAxMy4zNCAyNCAyMCAyNFoiLz4KPC9zdmc+Cjwvc3ZnPg=='}" 
                             alt="–ê–≤–∞—Ç–∞—Ä" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px;">
                        <h3>${user.nickname}</h3>
                        <p>@${user.username}</p>
                    </div>
                `;
            } else {
                content = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${chat.avatar || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiM4YTJiZTIiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJ3aGl0ZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDBDMjIuNjYgMCAyNC44NiAxLjM0IDI2LjM0IDMuM0MyNy44NiA1LjI2IDI4LjY2IDcuNzQgMjguNjYgMTAuNjZDMjguNjYgMTMuNiAyNy44NiAxNiAyNi4zNCAxOEM0OC00IDI0Ljg2IDIwIDIwIDIwQzE1LjE0IDIwIDEyIDE2Ljg2IDEyIDEyQzEyIDcuMTQgMTUuMTQgNCAyMCA0Wk0yMCAyNEMyNi42NiAyNCAzMiAyOS4zQzMyIDM2SDhDOCwyOS4zNCAxMy4zNCAyNCAyMCAyNFoiLz4KPC9zdmc+Cjwvc3ZnPg=='}" 
                             alt="–ê–≤–∞—Ç–∞—Ä" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px;">
                        <h3>${chat.title}</h3>
                        <p>–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</p>
                    </div>
                    <div>
                        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h4>
                        <ul>
                            ${chat.participants.map(username => `<li>${users[username]?.nickname || username}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            chatInfoContent.innerHTML = content;
            document.getElementById('chatInfoModal').classList.add('active');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
        function deleteChat() {
            if (!currentChatId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞.')) {
                return;
            }
            
            // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
            chats[currentChatId].messages = [];
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            saveData();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateMessages();
            updateChatsList();
            
            alert('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function isValidUsername(username) {
            const re = /^[a-zA-Z0-9]+$/;
            return re.test(username);
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>
